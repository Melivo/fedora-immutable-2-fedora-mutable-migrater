# distro-migrater-fi2f
#### Video Demo:  https://youtu.be/mb6kDln25y8
#### Description:
distro-migrater-fi2f is a small but practical migration tool for backing up and restoring your dotfiles, flatpaks and layered-RPMs as normal RPMs from a Fedora immutable (OSTree-based) workstation to a Fedora mutable system. It is designed
as a CS50 final project that solves a real problem I had:
I am using Bazzite on my main PC and freshly installed Fedora on my laptop. I wanted to restore my settings and apps on my laptop, without turning the tool into a risky "auto-magic" installer.

The project is designed to run from a USB-stick.

The project intentionally has a narrow scope. It targets Fedora-like systems and
assumes KDE as the main desktop environment. It does not claim to handle every
distro or every desktop environment, and it does not try to perfectly translate
all Flatpak apps into RPMs. Instead, it follows two design principles:

1) Ask before doing anything ambiguous. (e.g. similar app names)
2) Keep the output auditable and reversible (logs, clear summaries, no silent
   mass installs).

At a high level, the tool has two modes:

Backup mode (run on an immutable Fedora-like system):
- Creates a backup folder under `./backups/backup-<unix_ts>/` in the same folder as the binary.
- Captures a minimal list of "layered" RPMs from `rpm-ostree status --json` and
  writes it as `layered-rpms.txt` instead of storing the whole JSON file.
- Captures a list of installed Flatpak apps as `flatpak-list.txt`.
- Copies Flatpak config directories from `~/.var/app/<app_id>/config` into
  `flatpak-configs/<app_id>/config`.
- Copies `~/.config` into `dot-config/` so general app settings are preserved.

Restore mode (run on a mutable Fedora-like system):
- Re-execs itself via sudo if needed (restore requires root for `dnf` and
  ownership fixes).
- Lets the user pick a backup folder.
- Installs layered RPMs via `dnf` using `layered-rpms.txt` (or falls back to
  older `rpm-ostree-status.json` files if needed).
- Converts Flatpaks to RPM candidates interactively. If the tool cannot map a
  Flatpak to a known RPM (or the user chooses "skip"), it records that app as
  "manual install needed" in the summary.
- Restores Flatpak configs into `~/.config/<name>/` using a consistent mapping
  (see "Design Choices" below).
- Restores the general `dot-config` backup into `~/.config/` using a merge
  (copy-on-top) strategy.
- Fixes ownership of restored configs back to the invoking user when running as
  root, so files are not left owned by `root`.

The tool always prints a clear summary at the end of a restore, including:
- The RPMs that were selected and installed.
- A list of apps that must be installed manually.
- A confirmation that config restore steps were completed.

## AI-tools I used
- I created a project folder in ChatGPT and called it CS50.
   It has a specialized prompt to not give me solutions directly and ask
   socratic questions.
   The prompt text is included in `ChatGPT-Project System Prompt.txt`.
- OpenAI Codex Addon for VS Code
  Which I used to refine my commentary and make it more explanative.
  I also used it to solves issues where the ChatGPT tutor suggested solutions that
  worked for older zig versions but not 0.15.2 which I have written this code with.
- Visual Studio Code AI-autocomplete
  I used this one to complete long syntax from library functions so I didn't need
  to type as much.
  I also used it to complete syntax I wasn't completely sure of since I am also using
  this project to learn zig.

## Project Files

This repository is intentionally simple.

- `ChatGPT-Project System Prompt.txt`
  This is the system prompt I used to discuss my ideas with the ChatGPT-project
  and get feedback and suggestions for my code.

- `src/main.zig`
  The entire implementation. It includes:
  - System detection (immutable vs mutable Fedora).
  - Backup and restore control flow.
  - Flatpak parsing and RPM candidate conversion.
  - Filesystem operations for copying configs.
  - Command execution helpers and safe user prompts.
  - Logging and final summaries.

The backup folders and logs are generated by the program:
- `backups/backup-<unix_ts>/`
  Each run creates a timestamped backup folder. This contains:
  - `flatpak-list.txt`
  - `layered-rpms.txt` (or fallback `rpm-ostree-status.json`)
  - `flatpak-configs/`
  - `dot-config/`
- `log-<timestamp>.log`
  A runtime log written next to the executable (fallback: current directory).

## Design Choices

1) Overwrite/merge config restore is acceptable.
   The restore logic copies backup configs on top of whatever exists in
   `~/.config`. This is deliberate: I want the restored system to keep its
   baseline settings while adding the old ones back. This is not a perfect merge
   tool and could overwrite some local changes, but it is predictable and
   reversible (the backup is still on USB).

2) Flatpak config restore only for the "regular path".
   Flatpak config folders are restored only when they match the standard path
   `~/.var/app/<app_id>/config`. This is the most common and reliable layout.
   Anything outside that path is not automatically migrated, because it may be
   app-specific or incompatible. The tool favors safety over deep heuristics.

3) Interactive RPM conversion.
   There is no perfect 1:1 mapping from Flatpak IDs to RPM names. The tool
   generates candidate RPM names based on the Flatpak ID and then checks which
   candidates exist in the repo. If multiple candidates exist, the user picks
   one. If no candidates are found, the app is listed for manual install. This
   keeps the restore process transparent and avoids silent mistakes.

4) Explicit scope.
   The project is intentionally limited to Fedora-like systems, and assumes KDE
   as the main desktop environment. It warns about potential issues if configs
   are restored across different desktop environments. This is a proof-of-
   concept migration tool, not a universal distro migration system.

## Limitations / Known Issues

- Flatpak-to-RPM conversion is heuristic and may miss apps.
- Configs are restored with a merge copy; there is no fine-grained conflict
  resolution.
- The tool does not attempt to migrate settings that live outside `~/.config`
  or `~/.var/app/<app_id>/config`.
- It is not designed to handle every distro or desktop environment.

## Future Work

- Optional allowlist/denylist for Flatpak config restore.
- Optional preloading of RPM metadata for faster candidate checks.
- Optional verification output showing exact binary names for installed RPMs.

## Build / Run

This project targets Zig 0.15.2.

```sh
zig run src/main.zig
```
